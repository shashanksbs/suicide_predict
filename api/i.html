from flask import Flask, request, jsonify, send_file
import google.generativeai as genai
import os
import re

app = Flask(__name__)

# Configure Gemini API
genai.configure(api_key="AIzaSyBADqoFQCnC5njtkGrEciTyzSug9hRck9A")  # Replace with your actual API key
model = genai.GenerativeModel(model_name="gemini-1.5-flash")

@app.route('/')
def index():
    return send_file('try.html')

@app.route('/predict', methods=['POST'])
def predict_puside():
    try:
        # Ensure you're getting the 'text_prompt' key correctly from the form
        user_input = request.form.get('text_prompt')  
        
        if not user_input:
            return jsonify({
                'status': 'error', 
                'message': 'No text prompt provided.'
            }), 400
        
        # Generate prediction using Gemini
        text_response = model.generate_content([f"Analyze the following text without providing a description: {user_input}. Include a risk assessment listing Occurring Puside risks%, Not Occurring Puside risks%, and Other Risk Factors%. Conclude with percentages only on the last line. Do not provide the information in table format."])
        
        prediction = text_response.text

        # Extract percentages using regular expressions
        occuring_pct = re.search(r"Occurring Puside risks%: (\d+)%", prediction)
        not_occuring_pct = re.search(r"Not Occurring Puside risks%: (\d+)%", prediction)
        other_risk_pct = re.search(r"Other Risk Factors%: (\d+)%", prediction)
        
        # Extracting the values, defaulting to 0 if not found
        occuring_pct_value = occuring_pct.group(1) if occuring_pct else 0
        not_occuring_pct_value = not_occuring_pct.group(1) if not_occuring_pct else 0
        other_risk_pct_value = other_risk_pct.group(1) if other_risk_pct else 0
        
        return jsonify({
            'status': 'success', 
            'prediction': prediction,
            'occuring_pct': occuring_pct_value,
            'not_occuring_pct': not_occuring_pct_value,
            'other_risk_pct': other_risk_pct_value
        })
    
    except Exception as e:
        return jsonify({
            'status': 'error', 
            'message': str(e)
        }), 500

if __name__ == '__main__':
    app.run(debug=True)
